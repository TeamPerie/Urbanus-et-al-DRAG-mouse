---
title: "figures"
author: "L Peri√©"
date: "18/09/2020"
output: html_document
---


```{r,echo=FALSE, warning=FALSE,message=FALSE, cache=FALSE}
#load packages
library("ggplot2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("plyr", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("reshape2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library(Seurat)

setwd("/Users/jasoncosgrove/Dropbox (Team_Perie)/BCM paper/resubmission nature com/Urbanus et al, DRAG mouse (github v2)/code for figures")
```

## figure 1C

```{r, echo=FALSE}
d <- read.delim("/Users/jasoncosgrove/Dropbox (Team_Perie)/BCM paper/resubmission nature com/Urbanus et al, DRAG mouse (github v2)/code for figures/%GFP.txt")
M <- d[1:98,1:4] #remove empty raws
ggplot(M, aes(x=tam, y=M,colour = tam)) + geom_boxplot(color = c("black","dark green"),lwd = 2,show.legend = F) + ylab("GFP+ myeloid cells (%)") + xlab ("") + theme_bw() + geom_jitter() +theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold")) +  scale_color_manual(values = c( "black", "dark green")) + NoLegend() #plot data

```

## figures 3B and S5C

```{r, echo=FALSE}
#load package
library("gplots")
library(corrplot)

#define clustering function
mydistM = function(z) dist(z,'eu') 
mydistK = function(z) as.dist(cor(z,method='pearson'))
myhclu = function(d) hclust(d,method='complete')

#load data
D <- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb repsum not blood samples-abfilt probability yuval super mouse.txt")
D <- D[c(4,2,1,5)] # reorder columns

#normalization to 10^5 for visualization purposes
norm.data <- apply(D[,-4],2, function(x) (x/sum(x)*10^5)) #normalized
d <- cbind(norm.data, D[,4]) #add back the column with Pgen
d <-as.data.frame(d) #reformat
names(d)[4] <- "Pgen" #name Pgen

#plot heatmap with Pgen>10^-4
T=10^-4 #define threshold
x <- d[which(d$Pgen<T),]  #select data
x <- asinh(x[,-4 ]) #arcsin transform
m <-as.matrix(x) #reformat otherwise heatmap don't work

m<- m[rowSums(m) > 0,]

pairs.breaks <- seq(0, 10, by=0.5) #define scale and colors
mycol <- colorpanel(n=length(pairs.breaks)-1,low="black",mid="green",high="red")  #define scale and colors
Mydist <- mydistM(t(m)) #distance computation
Myclu<-myhclu(Mydist) #cluster computation
myhm = function(y) heatmap(y, distfun=mydistM, hclustfun=myhclu,scale="none",breaks=pairs.breaks, col=mycol, labCol = NULL, cexCol=0.6, Colv=reorder(as.dendrogram(Myclu),1:3)) #run heatmap


z <- myhm(m) #plot heatmap

#figures S5C can be generated changing the value of T
```



## figures 3C, 3D and S5D

```{r, echo=FALSE}
#categorize, compute number of bc in each category per mouse and cumulative contribution of the category in HSC,MP and M per mouse, plot average and sd
#load data
D <- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb repsum not blood samples-abfilt probability yuval super mouse.txt")
D <- D[c(4,2,1,5,6)] #reorder column for plotting
names(D)[4] <- "Pgen" #rename column
#select data of the right threshold
T=10^-4 #define threshold
d <- D[which(D$Pgen<T),] #select data with threshold
d <- d[which(rowSums(d[,1:3])>0),] #remove empty rows
       
#normalization each mouse total read to 100
dd<- d[,-4] #remove Pgen column
names(dd) <- c("LSK","MP","M","mouse") #change names
norm <- ddply(dd, "mouse", summarize, LSK=LSK/sum(LSK)*100, MP=MP/sum(MP)*100,M=M/sum(M)*100) #renorm
norm <- cbind(norm, d$Pgen) # add back the Pgen column

#categorization
#compute rowsum
x <- cbind(norm,rowSums(norm[,2:4])) #add rowsum to the table
x <- cbind(x, x[,2]/x[,6]*100, x[,3]/x[,6]*100,x[,4]/x[,6]*100) #compute %
x <- x[,-6] #removerowsum column
z <- numeric() #create empty vector
zz <- numeric() #create empty vector
#apply threshold for categorization and categorize bc
a =0
H <- x[which((x[,6]>a) & (x[,7]==a ) & (x[,8]==a )),] #select barcode only present in LSK
H <- cbind(rep("HSPC",dim(H)[1]),H) #save barcode in a table
names(H)[1] <- c("class") #name the column class
P <- x[which((x[,7]>a ) & (x[,6]==a ) & (x[,8]==a )),] #select barcode only present in MP
P <- cbind(rep("MP",dim(P)[1]),P)
names(P)[1] <- c("class")
M <- x[which((x[,8]>a ) & (x[,6]==a ) & (x[,7]==a )),]#select barcode only present in M
M <- cbind(rep("M",dim(M)[1]),M)
names(M)[1] <- c("class")
HPM <- x[which((x[,6]>a ) & (x[,7]>a ) & (x[,8]>a)),]#select barcode only present in LSK and MP and M
HPM <- cbind(rep("HSPC-MP-M",dim(HPM)[1]),HPM)
names(HPM)[1] <- c("class")
HP <- x[which((x[,6]>a) & (x[,7]>a ) & (x[,8]==a )),]#select barcode only present in LSK and MP
HP <- cbind(rep("HSPC-MP",dim(HP)[1]),HP)
names(HP)[1] <- c("class")
MP <- x[which((x[,7]>a) & (x[,8]>a ) & (x[,6]==a )),]#select barcode only present in M and MP
MP <- cbind(rep("MP-M",dim(MP)[1]),MP)
names(MP)[1] <- c("class")
HM <- x[which((x[,6]>a) & (x[,8]>a ) & (x[,7]==a )),]#select barcode only present in LSK and M
HM <- cbind(rep("HSPC-M",dim(HM)[1]),HM)
names(HM)[1] <- c("class")
zz <- rbind(H,P,M,HPM,HP,MP,HM) # create a summary table for all classes
z <- cbind(a,zz) #add the value of threshold to the table

#reformat and save the file
names(z) <-c("threshold","class","mouse","LSK","MP","M", "Pgen", "purentLSK", "purcentMP", "purcentM") # rename column 
write.table(z, "BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 Pgen<10-4 classification.txt",quote=F, sep="\t", row.names=F ) #save table

#summarize % of bc in each category per mouse (figure 3C)
count <-ddply(z, c("threshold", "mouse", "class"), summarize, count=length((class)))#count number of barcode per class per mouse
totn <-ddply(count, c("threshold", "mouse"), summarize, totn=sum(count)) #count number of barcode per mouse
count <- merge(count,totn) #merge the two information
count <-ddply(count, c("threshold", "mouse", "class", "count","totn"), summarize, freq=count/totn*100) #compute the %
#compute mean and sd
countmean <- ddply(count, c("threshold", "class"), summarize,mean=mean(freq), sd=sd(freq))
#plot for threshold=0
p <- countmean[which(countmean$threshold==0),]
p <- countmean[which(countmean$threshold==0),]
ggplot(p, aes(x=class, y=mean)) +geom_bar(stat="identity")+ labs(title = "") + ylab("barcode per class (%)") + geom_errorbar(aes(ymax=mean+sd,  ymin=mean))+ theme_bw()+ scale_x_discrete(drop=FALSE)+ theme_bw()+xlab("") 

p$class <- factor(p$class,levels = c("HSPC","MP","M","HSPC-MP-M","HSPC-MP","MP-M" ))

ggplot(p, aes(x=class, y=mean)) +geom_bar(stat="identity",color = "black", fill = c("red","darkolivegreen3","grey","plum","orange","cornflowerblue"),lwd = 2)+ labs(title = "") + ylab("barcode per class (%)") + geom_errorbar(aes(ymax=mean+(sd/2),  ymin=mean - (sd/2),width = 0.5),size = 0.5,color = "grey50")+ theme_bw()+ scale_x_discrete(drop=FALSE)+ theme_bw()+xlab("") +theme(axis.text=element_text(size=13,face="bold"),
        axis.title=element_text(size=25,face="bold")) 

#compute % of cells produced by each category (figure 3D)
Z <- ddply(z, c("threshold", "mouse", "class"), summarize, LSK=sum(LSK), P=sum(MP),M=sum(M), meanP=mean(Pgen))
mean <-ddply(Z, c("threshold", "class"), summarize, meanLSK=mean(LSK),sdLSK=sd(LSK), meanP=mean(P),sdP=sd(P), meanM=mean(M),sdM=sd(M) ) 
#reformat for the plotting
LSK <- cbind("LSK",mean[,1:4])
names(LSK) <- c("type", "threshold", "class","contrib","sd")
MP <- cbind("P",mean[,c(1,2,5,6)])
names(MP) <- c("type", "threshold", "class","contrib","sd")
M <- cbind("M",mean[,c(1,2,7,8)])
names(M) <- c("type", "threshold", "class","contrib","sd")
ZZ <- rbind(LSK,MP,M)
# plot with threshold=0
pp <- ZZ[which(ZZ$threshold==0),]

pp$class <- factor(pp$class,levels = c("HSPC","MP","M","HSPC-MP-M","HSPC-MP","MP-M" ))

pp$type <- factor(pp$type,levels = c("LSK","P","M"))


# Fig3D
ggplot(pp, aes(fill=class, x=type, y=contrib)) + geom_bar(position="fill", stat="identity",color = "black",lwd = 1.3) + theme_bw() + ylab("Proportional contribution to cell type") + xlab("") +scale_fill_manual(values= c("red","orange","plum","grey","darkolivegreen3","cornflowerblue")) +theme(axis.text=element_text(size=17,face="bold"),
        axis.title=element_text(size=20,face="bold")) + NoLegend()


#check Pgen distribution for the different classes (figure S5D)
A <- ddply(z, c("threshold", "mouse", "class","LSK", "MP", "M","Pgen"), summarize, tot= LSK+MP+M)
tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=8, height=6, res=300)
ggplot(A, aes(, x=tot, y=Pgen, col=class)) + geom_point() + scale_y_log10()+ xlab("abundance in reads")+ theme_bw() +theme(axis.text=element_text(size=17,face="bold"),
        axis.title=element_text(size=20,face="bold"))
dev.off()


#check clone size distribution per classes
#reformat for the plotting
LSK <- cbind("LSK",z[,2:4])
names(LSK) <- c("pop","class", "mouse", "contrib")
MP <- cbind("P",z[,c(2,3,5)])
names(MP) <- c("pop","class", "mouse", "contrib")
M <- cbind("M",z[,c(2,3,6)])
names(M) <- c("pop","class", "mouse", "contrib")
Y <- rbind(LSK,MP,M)

ggplot(Y, aes (x=pop,y=contrib, color=class)) +geom_boxplot(outlier.shape = NA) + xlab("") + theme_bw() + scale_y_continuous(name = "Cell output per barcode",trans='log10')+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(M, aes (x=pop,y=contrib, color=class)) +geom_boxplot(outlier.shape = NA) + xlab("") + theme_bw() 
+ scale_y_continuous(name = "Cell output per barcode",trans='log10')+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

```

##figure 4B

```{r, echo=FALSE}
#load data
D <- read.delim("%cell in GFP+ and neg over time.txt")
#format data
D <- D[,-3] #remove the ID column
x <- D[which(D$mouse %in% c(1:4)),] #select experimental mice
x <-x[,c(1,2,3,7,9)] #subset columns
x$type <- "M" #add type column
x$numbM <- x$M*x$numb/100 #add total number column
x$organ <- "BL" #add Blood column
x<- x[which(x$month<13),] #select data up to 12 months
#ploting
ggplot(x, aes(x=month, y=numbM)) + geom_point(aes(color=mouse))+ theme_bw() + facet_wrap(~GFP, scales="free_y")+scale_y_log10()+ ylab("myeloid cell numbers")+ xlab("Month")+ geom_smooth(method = lm, se = TRUE) +theme(axis.text=element_text(size=17,face="bold"),
        axis.title=element_text(size=20,face="bold"))

```


## figures 3E and 4D

```{r, echo=FALSE}
#load cell numbers data
D<- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb repsum.txt")
D <- D[,-grep("_L", colnames(D))]
D <- D[,-grep("_SP", colnames(D))]
names(D)[1]<- "tag"

#reformat data
d2 <- melt(D, id.vars="tag") # change from wide to long
d2<- d2[which(d2$value>0),]#remove zero values
d3 <- cbind( d2, ldply(strsplit(as.character(d2$variable), "_"), identity) ) # split the identifier column
names(d3) <- c("tag","id","var","mouse","month","organ","type") #give name to categories
d3<- d3[which(d3$var>0),] #remove zero values
d3 <- d3[,-2]#remove names

#select data in BM
z<- d3[which(d3$organ=="BM"),] #select data in BM
z<- z[which(z$type=="M"),] #select data for M
z$mouse <- sub("X","",z$mouse) # remove X in the name of the mouse
z$month <- as.numeric (z$month) #make sure that the month values are taken as numeric to have the right order 

#plot cell output per barcode for BM month 15 data, figure 3E
tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=6, height=6, res=300)
ggplot(z, aes (x=factor(month),y=var+1)) +geom_boxplot(outlier.shape = NA) + geom_jitter(aes(colour = mouse),size=1.0) + xlab("myeloid cells in bone marrow") + theme_bw() + scale_y_continuous(name = "Cell output per barcode",trans='log10')+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()

#select data in blood from 4 to 12 months
z<- d3[which(d3$month %in% c(4:12)),] #select data up to 12 months
z$mouse <- sub("X","",z$mouse) # remove X in the name of the mouse
z$month <- as.numeric (z$month) #make sure that the month values are taken as numeric to have the right order in the figure
write.table(z, "BCM run 3 and 4 freq10frac0_allsamples_norm 1_0.003 renorm norm cell numb sumrep long format.txt",row.names=FALSE, sep="\t") # export table for statistics
#plot cell output per barcode in blood from 4 to 12 months, Figure 4D

#plot cell output per barcode for BM month 15 data, figure 3E
tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=12, height=6, res=300)
ggplot(z, aes (x=factor(month),y=var+1)) +geom_boxplot(outlier.shape = NA) + geom_jitter(aes(colour = mouse), size=1, ) +xlab("Month post-induction") + theme_bw() + scale_y_continuous(name = "Cell output per barcode",trans='log10')+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()

```

##statistical test that no trend of increase or decrease cell output per barcode over time for fig 4D

We want to test that there is no trend of increase or decrease of the cell output per barcode over time. 

We fit a gamma generalized linear mixed model including random intercepts and slopes over time per mouse, and different dispersion per mouse. Let $Y_{ijk}$ be the response for the $i-$th mouse, $j-$th tag and $k-$th time point. We assume that

\begin{eqnarray*}
Y_{ijk}|m_{0i},m_{1i},t_{0ij}&\sim&\mbox{Gamma}(\mu_{ijk},\phi_i) \\
m_{0i} &\sim& \mbox{N}(0,\sigma^2_{m0}) \\
m_{1i} &\sim& \mbox{N}(0,\sigma^2_{m1}) \\
t_{0ij} &\sim& \mbox{N}(0,\sigma^2_{t0}) \\
\log\mu_{ijk} &=& \beta_0 + m_{0i} + t_{0ij} + (\beta_1 + m_{1i})\mbox{time}_k \\
\log\phi_i &=& \gamma_i
\end{eqnarray*}

where $m_{0i}$ and $m_{1i}$ are the random intercept and slope for mouse $i$ and $t_{0ij}$ is the random intercept for tag $j$ within mouse $i$.

We test two statistical hypotheses:

1. $H_0:\beta_1=0$ versus $H_a:\beta_1\neq0$
2. $H_0:\sigma^2_{t0}=0$ versus $H_0:\sigma^2_{t0}>0$

We test these hypotheses using likelihood-ratio (LR) tests for nested models. Not rejecting hypothesis (1) is equivalent to confirming scientific hypothesis (I). Rejecting hypothesis (2) is equivalent to confirming scientific hypothesis (II).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(glmmTMB)

#Reading the dataset into R
bcm <- read.table("BCM run 3 and 4 freq10frac0_allsamples_norm 1_0.003 renorm norm cell numb sumrep long format.txt",header = TRUE) %>% as_tibble

# confirming organ and type
bcm <- bcm %>%
  filter(organ == "BL" & type == "M")
bcm$mouse <- as.factor(bcm$mouse)
bcm$tag <- as.factor(bcm$tag)
bcm$month_scaled <- scale(bcm$month) %>% as.numeric

## testing that there is no trend of increase or decrease cell output per barcode over time

### Model fitting

fit <- glmmTMB(var ~ month_scaled +
                 (1 | mouse) + (0 + month_scaled | mouse) +
                 (1 | mouse:tag),
               dispformula = ~ mouse,
               family = Gamma(link = log),
               data = bcm)

summary(fit)

## Checking goodness-of-fit
dfun <- function(obj) {
  resid(obj)
}

sfun <- function(n, obj) {
  simulate(obj)$sim_1
}

ffun <- function(resp) {
  glmmTMB(resp ~ month_scaled +
            (1 | mouse) + (0 + month_scaled | mouse) +
            (1 | mouse:tag),
          dispformula = ~ mouse,
          family = Gamma(link = log),
          data = bcm)
}

## takes a while to run
hnp(fit, newclass = TRUE, diagfun = dfun, simfun = sfun, fitfun = ffun,
    paint = TRUE)

#testing hypothesis
fit_1 <- glmmTMB(var ~ 1 +
                   (1 | mouse) + (0 + month_scaled | mouse) +
                   (1 | mouse:tag),
                 dispformula = ~ mouse,
                 family = Gamma(link = log),
                 data = bcm)

anova(fit, fit_1)
```

We have that $\mbox{LR}=0.58$, $\mbox{d.f.}=1$, $p=0.45$. Therefore, we fail to reject hypothesis 1 and conclude that $\beta_1=0$, i.e. there is no trend over time.

## figure 4B, S6B, S6C

Jos in 2006 has proposed a formula that enables to compute all the diversity measures (shannon, simpson etc...) with one formula call the hill numbers. 

$$^qD= (\sum_{i}^{s} p_i^q)^\frac{1}{1-q}$$
where q is the order of the diversity.pi is the frequency of a given barcode in the dataset. 
for q=1 the formula is undefined and one should take the limit which gives:
$$^1D= exp(-\sum_{i}^{s} p_i ln(p_i))$$

q=0 is the simple richness so the number of barcodes in the sample
q=1 is the shannon index
q=2 is the simpson index. 
higher q don't have names but it is interesting to look at the slode of D with increasing q, as it gves you an idea of the contribution of abundant barcodes versus low abundant ones. Basically the more q increases the more weight you put on abundant barcodes as pi is powered by q. the flatter the slope of D versus q the more equal are the size of the family. 

```{r, echo=FALSE}
#compute hill numbers
#load data 
d<- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm.txt")

#we need data to be renormalized to 1
#renormalization to 1
M <- d
rownames(M) <- M[,1]
M<- M[,-1]

#formula diversity ref Oikos_2006_Jost
#n=1
D1 = function(x) {exp(-sum(x[x>0]*log(x[x>0]), na.rm=TRUE))}
#other n
Dq = function(x,q) {sum(x[x>0]^q)^(1/(1-q))}

# compute diversity
N <- M
S <- numeric(0)
for (i in 2:ncol(N)) {
  x <- N[,i]
  name <- colnames(N)[i]
  S <- rbind(S,cbind(name,Dq(x,0),D1(x),Dq(x,2),Dq(x,3),Dq(x,4),Dq(x,5), Dq(x,6)))
}
S <- as.data.frame(S)
S <- cbind(S, ldply(strsplit(as.character(S$name), "_"), identity) ) # split the identifier column
names(S) <- c("name","richness", "Shannon", "Simpson", "hill 3", "hill 4", "hill 5", "hill 6","mouse", "month", "organ", "type", "replicate")
S <- S[,-1]
S <- S[S$mouse %in% c("X1","X2","X3","X4"),]
#S <- S[S$month %in% c("4","5","6","7","8","9","10","11","12","13","14", "15"),]
write.table(S, "BCM run 3 and 4 freq10frac0_allsamples_norm 1_0.003 renorm hill number per rep.txt",row.names=FALSE, sep="\t")

```

```{r, echo=FALSE}
bcm1 <- read.table("BCM run 3 and 4 freq10frac0_allsamples_norm 1_0.003 renorm hill number per rep.txt",header = TRUE)
bcm1 <- bcm1[bcm1$type=="M",]
bcm1 <- bcm1[bcm1$month<13,]

## here we do minor manipulation just to organise the dataset and ease visualisation
bcm1 <- bcm1[c(5,6,61,62,7:14,1:4,59:60,65:68,19:26,15:18,63,64,31:42,27:30,69,70,
               47:58,43:46,71,72),]
bcm1$mm <- with(bcm1, mouse:factor(month))
bcm1$Mouse <- bcm1$mouse
levels(bcm1$Mouse) <- 1:4
#head(bcm1)
```

A gamma GLM gives evidence of a reasonably good fit. This makes sense, since the data are slightly right-skewed.

```{r, fig.height = 8, fig.width = 8, echo=FALSE}
require(hnp)
m1 <- glm(richness ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)
m2 <- glm(Shannon ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)
m3 <- glm(Simpson ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)
m4 <- glm(hill.3 ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)
m5 <- glm(hill.4 ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)
m6 <- glm(hill.5 ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)
m7 <- glm(hill.6 ~ poly(month, 2), family = Gamma(link = "identity"), data = bcm1)

par(mfrow = c(2,2))
hnp(m3, print = T); hnp(m2, print = T); hnp(m3, print = T); hnp(m4, print = T)
par(mfrow = c(1,1))
my.hnp3 <- hnp(m3, print = F, plot=FALSE)
plot(my.hnp3,cex=1, cex.lab=2,cex.axis=2)

```

Let $Y_{ijk}$ be the random variable representing a continuous measurement of richness, made on mouse $i$, month $j$, and sub-sample $k$. We may assume that
\begin{eqnarray}\label{model1}
Y_{ijk}|m_i,b_{ij}&\sim&\mbox{Gamma}(\mu_{ijk},\phi)\\
\nonumber m_i&\sim&N(0,\sigma^2_m),\\
\nonumber b_{ij}&\sim&N(0,\sigma^2_b), \\
\nonumber \mu_{ijk}&=&f(\mbox{month}_j)+m_i+b_{ij},
\end{eqnarray}
where $f(\mbox{month}_j)$ is a function describing the behaviour of observations over time, $m_i$ is the random effect associated with the $i-$th mouse, $b_{ij}$ is the random effect associated with the $j-$th measurement taken on the $i-$th mouse, and $\phi$ is the dispersion parameter.

Here, we will consider a parametric approaches to describe the behaviour over time:
\begin{enumerate}
\item a piecewise-linear predictor: $f(\mbox{month}_j)=\beta_0+\beta_1\mbox{month}_j\mbox{I}(\mbox{month}_j\leq\kappa)+\beta_2\mbox{month}_j\mbox{I}(\mbox{month}_j>\kappa),$ with $\kappa$ the breakpoint estimated by maximising the profile log-likelihood of model (\ref{model1})
\end{enumerate}

```{r, echo=FALSE}
#Estimating the break points by maximising the profile log-likelihood
require(lme4)

lik.break <- function(b, y) {
  bcm2 <- bcm1
  bcm2$month.b <- ifelse(bcm2$month < b, 0, bcm2$month - b)
  ll <- logLik(glmer(y ~ month + month.b + (1 | mouse) + (1 | mm),
                     family = Gamma(link = "identity"), data = bcm2))
  return(as.numeric(- ll))
}
br.richness <- optimize(lik.break, interval = c(6.9, 9), y = bcm1$richness)$minimum
br.Shannon <- optimize(lik.break, interval = c(4, 12), y = bcm1$Shannon)$minimum
br.Simpson <- optimize(lik.break, interval = c(4, 12), y = bcm1$Simpson)$minimum
br.hill.3 <- optimize(lik.break, interval = c(4, 12), y = bcm1$hill.3)$minimum
br.hill.4 <- optimize(lik.break, interval = c(4, 12), y = bcm1$hill.4)$minimum
br.hill.5 <- optimize(lik.break, interval = c(4, 12), y = bcm1$hill.5)$minimum
br.hill.6 <- optimize(lik.break, interval = c(4, 12), y = bcm1$hill.6)$minimum

bcm1$month.brichness <- ifelse(bcm1$month < br.richness, 0, bcm1$month - br.richness)
bcm1$month.bShannon <- ifelse(bcm1$month < br.Shannon, 0, bcm1$month - br.Shannon)
bcm1$month.bSimpson <- ifelse(bcm1$month < br.Simpson, 0, bcm1$month - br.Simpson)
bcm1$month.bhill.3 <- ifelse(bcm1$month < br.hill.3, 0, bcm1$month - br.hill.3)
bcm1$month.bhill.4 <- ifelse(bcm1$month < br.hill.4, 0, bcm1$month - br.hill.4)
bcm1$month.bhill.5 <- ifelse(bcm1$month < br.hill.5, 0, bcm1$month - br.hill.5)
bcm1$month.bhill.6 <- ifelse(bcm1$month < br.hill.6, 0, bcm1$month - br.hill.6)
```


```{r, echo=FALSE}
#Fitting the models
fitpw.richness <- glmer(richness ~ month + month.brichness + (1 | mouse) + (1 | mm),
                        family = Gamma(link = "identity"), data = bcm1)
fitpw.Shannon <- glmer(Shannon ~ month + month.bShannon + (1 | mouse) + (1 | mm),
                       family = Gamma(link = "identity"), data = bcm1)
fitpw.Simpson <- glmer(Simpson ~ month + month.bSimpson + (1 | mouse) + (1 | mm),
                       family = Gamma(link = "identity"), data = bcm1)
fitpw.hill.3 <- glmer(hill.3 ~ month + month.bhill.3 + (1 | mouse) + (1 | mm),
                      family = Gamma(link = "identity"), data = bcm1)
fitpw.hill.4 <- glmer(hill.4 ~ month + month.bhill.4 + (1 | mouse) + (1 | mm),
                      family = Gamma(link = "identity"), data = bcm1,
                      control = glmerControl(calc.derivs = F))
fitpw.hill.5 <- glmer(hill.5 ~ month + month.bhill.5 + (1 | mouse) + (1 | mm),
                      family = Gamma(link = "identity"), data = bcm1)
fitpw.hill.6 <- glmer(hill.6 ~ month + month.bhill.6 + (1 | mouse) + (1 | mm),
                      family = Gamma(link = "identity"), data = bcm1)
```

Obtaining predicted curves and confidence intervals --
```{r, echo=FALSE}
bcm.pred.pw <- expand.grid(month = seq(4, 12, length = 100))
bcm.pred.pw$month.brichness <- ifelse(bcm.pred.pw$month < br.richness, 0, bcm.pred.pw$month - br.richness)
bcm.pred.pw$month.bShannon <- ifelse(bcm.pred.pw$month < br.Shannon, 0, bcm.pred.pw$month - br.Shannon)
bcm.pred.pw$month.bSimpson <- ifelse(bcm.pred.pw$month < br.Simpson, 0, bcm.pred.pw$month - br.Simpson)
bcm.pred.pw$month.bhill.3 <- ifelse(bcm.pred.pw$month < br.hill.3, 0, bcm.pred.pw$month - br.hill.3)
bcm.pred.pw$month.bhill.4 <- ifelse(bcm.pred.pw$month < br.hill.4, 0, bcm.pred.pw$month - br.hill.4)
bcm.pred.pw$month.bhill.5 <- ifelse(bcm.pred.pw$month < br.hill.5, 0, bcm.pred.pw$month - br.hill.5)
bcm.pred.pw$month.bhill.6 <- ifelse(bcm.pred.pw$month < br.hill.6, 0, bcm.pred.pw$month - br.hill.6)

bcm.pred.pw$richness <- predict(fitpw.richness, bcm.pred.pw, re.form = NA, type = "response")
bcm.pred.pw$Shannon <- predict(fitpw.Shannon, bcm.pred.pw, re.form = NA, type = "response")
bcm.pred.pw$Simpson <- predict(fitpw.Simpson, bcm.pred.pw, re.form = NA, type = "response")
bcm.pred.pw$hill.3 <- predict(fitpw.hill.3, bcm.pred.pw, re.form = NA, type = "response")
bcm.pred.pw$hill.4 <- predict(fitpw.hill.4, bcm.pred.pw, re.form = NA, type = "response")
bcm.pred.pw$hill.5 <- predict(fitpw.hill.5, bcm.pred.pw, re.form = NA, type = "response")
bcm.pred.pw$hill.6 <- predict(fitpw.hill.6, bcm.pred.pw, re.form = NA, type = "response")

beta_hat.richness <- fixef(fitpw.richness)
beta_hat.Shannon <- fixef(fitpw.Shannon)
beta_hat.Simpson <- fixef(fitpw.Simpson)
beta_hat.hill.3 <- fixef(fitpw.hill.3)
beta_hat.hill.4 <- fixef(fitpw.hill.4)
beta_hat.hill.5 <- fixef(fitpw.hill.5)
beta_hat.hill.6 <- fixef(fitpw.hill.6)
Xnew.richness <- model.matrix(~ month + month.brichness, bcm.pred.pw)
Xnew.Shannon <- model.matrix(~ month + month.bShannon, bcm.pred.pw)
Xnew.Simpson <- model.matrix(~ month + month.bSimpson, bcm.pred.pw)
Xnew.hill.3 <- model.matrix(~ month + month.bhill.3, bcm.pred.pw)
Xnew.hill.4 <- model.matrix(~ month + month.bhill.4, bcm.pred.pw)
Xnew.hill.5 <- model.matrix(~ month + month.bhill.5, bcm.pred.pw)
Xnew.hill.6 <- model.matrix(~ month + month.bhill.6, bcm.pred.pw)
std_lp.richness <- sqrt(diag(Xnew.richness %*% vcov(fitpw.richness) %*% t(Xnew.richness)))
std_lp.Shannon <- sqrt(diag(Xnew.Shannon %*% vcov(fitpw.Shannon) %*% t(Xnew.Shannon)))
std_lp.Simpson <- sqrt(diag(Xnew.Simpson %*% vcov(fitpw.Simpson) %*% t(Xnew.Simpson)))
std_lp.hill.3 <- sqrt(diag(Xnew.hill.3 %*% vcov(fitpw.hill.3) %*% t(Xnew.hill.3)))
std_lp.hill.4 <- sqrt(diag(Xnew.hill.4 %*% vcov(fitpw.hill.4) %*% t(Xnew.hill.4)))
std_lp.hill.5 <- sqrt(diag(Xnew.hill.5 %*% vcov(fitpw.hill.5) %*% t(Xnew.hill.5)))
std_lp.hill.6 <- sqrt(diag(Xnew.hill.6 %*% vcov(fitpw.hill.6) %*% t(Xnew.hill.6)))
bcm.pred.pw$richness.u <- Xnew.richness%*%beta_hat.richness + qnorm(0.975)*std_lp.richness
bcm.pred.pw$richness.l <- Xnew.richness%*%beta_hat.richness - qnorm(0.975)*std_lp.richness
bcm.pred.pw$Shannon.u <- Xnew.Shannon%*%beta_hat.Shannon + qnorm(0.975)*std_lp.Shannon
bcm.pred.pw$Shannon.l <- Xnew.Shannon%*%beta_hat.Shannon - qnorm(0.975)*std_lp.Shannon
bcm.pred.pw$Simpson.u <- Xnew.Simpson%*%beta_hat.Simpson + qnorm(0.975)*std_lp.Simpson
bcm.pred.pw$Simpson.l <- Xnew.Simpson%*%beta_hat.Simpson - qnorm(0.975)*std_lp.Simpson
bcm.pred.pw$hill.3.u <- Xnew.hill.3%*%beta_hat.hill.3 + qnorm(0.975)*std_lp.hill.3
bcm.pred.pw$hill.3.l <- Xnew.hill.3%*%beta_hat.hill.3 - qnorm(0.975)*std_lp.hill.3
bcm.pred.pw$hill.4.u <- Xnew.hill.4%*%beta_hat.hill.4 + qnorm(0.975)*std_lp.hill.4
bcm.pred.pw$hill.4.l <- Xnew.hill.4%*%beta_hat.hill.4 - qnorm(0.975)*std_lp.hill.4
bcm.pred.pw$hill.5.u <- Xnew.hill.5%*%beta_hat.hill.5 + qnorm(0.975)*std_lp.hill.5
bcm.pred.pw$hill.5.l <- Xnew.hill.5%*%beta_hat.hill.5 - qnorm(0.975)*std_lp.hill.5
bcm.pred.pw$hill.6.u <- Xnew.hill.6%*%beta_hat.hill.6 + qnorm(0.975)*std_lp.hill.6
bcm.pred.pw$hill.6.l <- Xnew.hill.6%*%beta_hat.hill.6 - qnorm(0.975)*std_lp.hill.6
```

Plots of the data + fitted curves:
```{r, echo=FALSE, fig.width = 4, fig.height = 3}
ggplot(data = bcm1, aes(x = month, y = richness)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity (Richness)") + geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = richness)) + geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = richness.l, ymax = richness.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(data = bcm1, aes(x = month, y = Shannon)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity (Shannon index)") + geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = Shannon)) + geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = Shannon.l, ymax = Shannon.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(data = bcm1, aes(x = month, y = Simpson)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity (Simpson index)") + geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = Simpson)) + geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = Simpson.l, ymax = Simpson.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(data = bcm1, aes(x = month, y = hill.3)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity(Hill number (3))") + geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = hill.3)) + geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = hill.3.l, ymax = hill.3.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(data = bcm1, aes(x = month, y = hill.4)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity(Hill number (4))") + geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = hill.4)) + geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = hill.4.l, ymax = hill.4.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(data = bcm1, aes(x = month, y = hill.5)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity(Hill number (5))") +geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = hill.5)) +geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = hill.5.l, ymax = hill.5.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))

ggplot(data = bcm1, aes(x = month, y = hill.6)) + theme_bw() + 
  scale_x_continuous(name = "Month post-induction") + scale_y_continuous(name = "Barcode diversity (Hill number (6))") + geom_jitter(mapping = aes(colour = Mouse), width = .1) + geom_line(data = bcm.pred.pw, mapping = aes(x = month, y = hill.6)) + geom_ribbon(data = bcm.pred.pw, mapping = aes(ymin = hill.6.l, ymax = hill.6.u), alpha = .2)+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
```

```{r, echo=FALSE}
#extrating information from the fit
timetowash <- rbind(c("richness", fixef(fitpw.richness) [1]/-fixef(fitpw.richness) [2]),c("shannon", fixef(fitpw.Shannon) [1]/-fixef(fitpw.Shannon) [2]), c("simpson", fixef(fitpw.Simpson) [1]/-fixef(fitpw.Simpson) [2]), c("hill 3", fixef(fitpw.hill.3) [1]/-fixef(fitpw.hill.3) [2]), c("hill 4", fixef(fitpw.hill.4) [1]/-fixef(fitpw.hill.4) [2]), c("hill 5", fixef(fitpw.hill.5) [1]/-fixef(fitpw.hill.5) [2]), c("hill 6", fixef(fitpw.hill.6) [1]/-fixef(fitpw.hill.6) [2]))
timetowash <- as.data.frame(timetowash)
names(timetowash) <- c("estimate", "time to wash out")

stem0 <- rbind(c("richness", (fixef(fitpw.richness) [1]-fixef(fitpw.richness) [3]*br.richness)/-(fixef(fitpw.richness) [2]+fixef(fitpw.richness) [3])),c("shannon", (fixef(fitpw.Shannon) [1]-fixef(fitpw.Shannon) [3]*br.Shannon)/-(fixef(fitpw.Shannon) [2]+fixef(fitpw.Shannon) [3])),c("simpson", (fixef(fitpw.Simpson) [1]-fixef(fitpw.Simpson) [3]*br.Simpson)/-(fixef(fitpw.Simpson) [2]+fixef(fitpw.Simpson) [3])), c("hill 3", (fixef(fitpw.hill.3) [1]-fixef(fitpw.hill.3) [3]*br.hill.3)/-(fixef(fitpw.hill.3) [2]+fixef(fitpw.hill.3) [3])), c("hill 4", (fixef(fitpw.hill.4) [1]-fixef(fitpw.hill.4) [3]*br.hill.4)/-(fixef(fitpw.hill.4) [2]+fixef(fitpw.hill.4) [3])), c("hill 5", (fixef(fitpw.hill.5) [1]-fixef(fitpw.hill.5) [3]*br.hill.5)/-(fixef(fitpw.hill.5) [2]+fixef(fitpw.hill.5) [3])), c("hill 6", (fixef(fitpw.hill.6) [1]-fixef(fitpw.hill.6) [3]*br.hill.6)/-(fixef(fitpw.hill.6) [2]+fixef(fitpw.hill.6) [3])))
stem0 <- as.data.frame(stem0)
names(stem0) <- c("estimate", "initial number of bc retaining cells")

X <- merge(timetowash,stem0)

dispstem<- rbind(c(0, fixef(fitpw.richness) [3]),c(1, fixef(fitpw.Shannon) [3]), c(2, fixef(fitpw.Simpson) [3]), c(3, fixef(fitpw.hill.3) [3]), c(4, fixef(fitpw.hill.4) [3]), c(5, fixef(fitpw.hill.5) [3]), c(6, fixef(fitpw.hill.6) [3]))

#making a table with the different coefficient

T <- cbind(c("richness", "shannon","simpson","hill3", "hill4","hill5","hill6"),c(round(br.richness, 4),round(br.Simpson, 4),round(br.Shannon, 4), round(br.hill.3, 4), round(br.hill.4, 4), round(br.hill.5, 4), round(br.hill.6, 4)), c(round(fixef(fitpw.richness) [1], 2), round(fixef(fitpw.Shannon) [1], 2), round(fixef(fitpw.Simpson) [1], 2),round(fixef(fitpw.hill.3) [1], 2), round(fixef(fitpw.hill.4) [1], 2),round(fixef(fitpw.hill.5) [1], 2), round(fixef(fitpw.hill.6) [1], 2)), c(round(fixef(fitpw.richness) [2], 2), round(fixef(fitpw.Shannon) [2], 2), round(fixef(fitpw.Simpson) [2], 2),round(fixef(fitpw.hill.3) [2], 2), round(fixef(fitpw.hill.4) [2], 2),round(fixef(fitpw.hill.5) [2], 2), round(fixef(fitpw.hill.6) [2], 2)), c(round(fixef(fitpw.richness) [3], 2), round(fixef(fitpw.Shannon) [3], 2), round(fixef(fitpw.Simpson) [3], 2),round(fixef(fitpw.hill.3) [3], 2), round(fixef(fitpw.hill.4) [3], 2),round(fixef(fitpw.hill.5) [3], 2), round(fixef(fitpw.hill.6) [3], 2)))

T <- as.data.frame(T)
names(T) <- c("renyi", "kappa", "beta 0", "beta 1", "beta 2")

write.table( T, "BCM run 3 and 4 fitted renyi parameters.txt",quote=F, sep="\t", row.names=F )


```


## figure S5E and F

The formula I use for the chao2 estimator is the following: 

Chao2 estimates the total number of species and is particularly useful for data sets skewed toward the low-abundance classes (Hugues JB, Appl Environ Microbiol 2001). But you need to trust these low abundance reads to be real. 

It is computed as follow:

$$chao2= Nobs + \frac{R-1}{R}\times{\frac{N_1^2}{2N_2}}$$

Nobs is the number of barcode observed, N1 is the number of barcodes observed only in one of the replicate and N2 the number of barcode observed in the two replicates. 
R is the number of repeats ie here 2 so A=(R-1)/R= 1/2

Our equation is therefore:
$$chao2= Nobs + \frac{1}{2}\times{\frac{N_1^2}{2N_2}}$$

The variance can be computed as follow:
$$Var(chao2)=N_2\times{\left(\frac{A}{2}\left({\frac{N_1}{N_2}}\right)^2+A^2\left({\frac{N_1}{N_2}}\right)^3+\frac{A^2}{4}\left({\frac{N_1}{N_2}}\right)^4\right)} $$
where A is (R-1)/R=1/2

So the equation simplified as follow:

$$Var(chao2)=N_2\times{\left(\left({\frac{N_1}{N_2}}\right)^2+\frac{1}{4}\left({\frac{N_1}{N_2}}\right)^3+\left({\frac{N_1}{N_2}}\right)^4\right)} $$

```{r, echo=FALSE}
#compute chao2 for all the data. 
library("ggplot2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("plyr", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("reshape2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library") 

#load data
dab <- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb a vs b.txt")
dab <- dab[,-1] # remove barcode name column

N2 <- dab[which(dab$vara>0 & dab$varb>0),] # select the barcodes present in both duplicates
N1 <- dab[which(dab$vara==0 | dab$varb==0),]# select the barcodes present in one duplicate

n2 <- ddply(N2, c("mouse","month","organ","type"),  nrow) # count the number of barcodes present in both duplicates
n1 <- ddply(N1, c("mouse","month","organ","type"),  nrow) #count the number of barcodes present in one duplicate
names(n2)[5] <- "N2"#rename
names(n1)[5] <- "N1" #rename
chao <- merge(n1,n2,all=T) # add both values
c <- chao$N1+chao$N2+(1/2)*(chao$N1)^2/(2*chao$N2) # compute chao2
var <- chao$N2*((chao$N1/chao$N2)^2+(1/4)*(chao$N1/chao$N2)^3+(chao$N1/chao$N2)^4) # compute var
sd <- sqrt(var) # compute Sd
chaoall <- cbind(chao,chao$N1+chao$N2,c,var, sd) #merge all in one table
names(chaoall)[c(7,8,9,10)]<- c("Nobs","chao","var", "sd") #rename columns
write.table(chaoall, "BCM run 3 and 4 freq10frac0_allsamples_0.003 renorm chao table on cell numb.txt",row.names=TRUE,col.names=NA, sep="\t")

#select Month 15 data
chaoBM15 <- chaoall[chaoall$month==15,] 
chaoBM15 <- chaoBM15[chaoBM15$organ== "BM",]
chaoBM15 <- chaoBM15[chaoBM15$type== "M",]
names(chaoBM15)[8:10] <- c("chao2", "var.chao2", "sd.chao2")
```

```{r,echo=FALSE, warning=FALSE,message=FALSE, cache=FALSE}
#compute diversity with different method with incidence data
library("biomod2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("vegan", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
#load data
D <- read.delim("BCM run 3 and 4 freq10frac0_allsamples_0.003 norm cell numb.txt")
d <- D[,grep("_15_BM_M_", names(D))] #select Month 15 myeloid data
d[d<1] <- 0 #set to zero the data below 1
d <- d[which(rowSums(d)>0),] #remve empty rows
y <- d[,grep("_15_BM_M_",colnames(d))] #select Month 15 myeloid data
z <- BinaryTransformation(y, 0) #binarize matrix
s <- numeric(0) #initialize vector
for (i in seq(1,dim(z)[2],2)) {
  x <- z[,c(i,i+1)]
  x <- x[rowSums(x)>0,]
  s <- rbind(s,specpool(t(x))) #estimate diversity
}
  
s <- as.data.frame(s) #transform to data frame 
row.names(s) <- names(y) [seq(1,dim(z)[2],2)] # make names
s$names <- row.names(s)

s <- cbind( s, ldply(strsplit(as.character(s$names), "_"), identity) ) # split the identifier column
names(s) [11:15] <- c("mouse","month","organ","type","rep") #give name to categories
s <- s[,-c(10,15)] #select interesting columns
names(s) [2:3] <- c("chao2.corr", "chao2.corr.se")

table <- merge(chaoBM15, s) #merge table with previous results
abund <- table[, -c(5,6,7,9,19)] # select columns of interest
colnames(abund) <- c("mouse","month","organ","type","est","sd","est","est","sd","est","sd","est","est","sd") # rename columns
abund<- rbind(abund[,c(1:4,8)],abund[,c(1:4,10)],abund[,c(1:4,13)])
abund$estimate <- c(rep("chao2corr",4), rep("jack1",4), rep("boot",4) )
abund$estimate <- factor(abund$estimate, levels = c( "chao2corr","boot", "jack1"),ordered = TRUE)
#plot fig S5F

tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=8, height=6, res=300)
ggplot(abund, aes(x=estimate,y=est)) + geom_boxplot(aes(group=estimate)) + theme_bw()+ ylab("Barcode diversity")+ xlab("") +theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()
```

NB: what changes between the two way to compute the chao2 is the computation of the sd. 

```{r, echo=FALSE}
#load data
chaoall <- read.delim("BCM run 3 and 4 freq10frac0_allsamples_0.003 renorm chao table on cell numb.txt")
chaoall <- chaoall[,-1]
#selec data
d <- chaoall[chaoall$month==15,]
d <- d[d$type!="L",]
d <- d[d$organ=="BM",]
d <- d[d$mouse %in% c("X1","X2","X3","X4"),]
d <- d[d$type!="DC",]
#chane order of factor for ploting
d$organ <- factor(d$organ, levels = c("BM","SP","BL"),ordered = TRUE)
d$type <- factor(d$type, levels = c("LSK","MP","M"),ordered = TRUE)
#plot fig S5E
d <- d[d$type!="SP",]


tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=8, height=6, res=300)
ggplot(d, aes(x=type, y=chao)) + geom_boxplot(aes(group=interaction(organ,type))) + ylab("Barcode diversity (chao2)")+ xlab("") + theme_bw()+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()

```


## figure S2B, D, E

```{r, echo=FALSE}
par(mfrow=c(2,2))
#load data
d <- read.delim("/Users/jasoncosgrove/Dropbox (Team_Perie)/BCM paper/resubmission nature com/Urbanus et al, DRAG mouse (github v2)/code for figures/BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm repsum complexity probability yuval.txt",sep="\t")

#complexity of the barcode present in mouse 1
x1 <- d[, grep("X1_", colnames(d))]
x1 <- x1[,-grep("_L", colnames(x1))]
#x1 <- x1[,grep("_BL_", colnames(x1))]
z1 <- cbind(rowSums(x1!=0), d$Pgen)
z1 <- z1[which(z1[,1]>0),]
#mouse 2
x2 <- d[, grep("X2_", colnames(d))]
x2 <- x2[,-grep("_L", colnames(x2))]
#x2 <- x2[,grep("_BL_", colnames(x2))]
z1 <- cbind(rowSums(x2!=0),d$Pgen)
z1 <- z1[which(z1[,1]>0),]
#mouse 3
x3 <- d[, grep("X3_", colnames(d))]
x3 <- x3[,-grep("_L", colnames(x3))]
#x3 <- x3[,grep("_BL_", colnames(x3))]
z1 <- cbind(rowSums(x3!=0),d$Pgen)
z1 <- z1[which(z1[,1]>0),]
#mouse 4
x4 <- d[, grep("X4_", colnames(d))]
x4 <- x4[,-grep("_L", colnames(x4))]
#x4 <- x4[,grep("_BL_", colnames(x4))]
z1 <- cbind(rowSums(x4!=0),d$Pgen)
z1 <- z1[which(z1[,1]>0),]

#sum per mouse
S <- cbind(rowSums(x1),rowSums(x2),rowSums(x3),rowSums(x4),d$seq_likelihood, d$Pgen)
S <- as.data.frame(S)
names(S) <- c("mouse 1", "mouse 2", "mouse 3", "mouse 4", "Pgen")
S <- S[which(rowSums(S[,-c(5,6)])>0),]

#complexity of the barcodes shared between mice
par(mfrow=c(1,1))
z1 <- cbind(rowSums(S[,-5]!=0),S[,5])
z1 <- z1[which(z1[,1]>0),]

#reformat for plotting
library("ggplot2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
z1 <- data.frame(z1)
z1[,1] <- as.factor(z1[,1])
names(z1) <- c("mice", "Pgen")
z2 <- cbind(rep(0,dim(z1)[1]),z1$Pgen)
z2 <- as.data.frame(z2)
names(z2) <- c("mice","Pgen")
z3 <- rbind(z2,z1)
z3 <- z3[z3$mice!="0",]
#plot S2B


tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=10, height=6, res=300)
ggplot(z3, aes (x= Pgen, fill=mice)) +geom_histogram(alpha=0.8)+  scale_x_log10() + ylab("density") + xlab("Pgen")+ theme_bw()+ labs(fill='')+ scale_fill_discrete(labels=c( "unique barcode", "barcode shared by 2/4 mice", "barcode shared by 3/4 mice", "barcode shared by 4/4 mice")) +theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()

#% of sharing between mice
par(mfrow=c(2,1))
w <- z1[which(z1[,2]>0),]
W <- c(0,table(w[,1]))
for (i in seq(1,8,0.5)) {
W <- rbind(W,c(i,table(z1[which(z1[,2]<10^-i),1])))
}
WW<-cbind(W[,1],W[,2]/rowSums(W[,-1]),(W[,3]+W[,4]+W[,5])/rowSums(W[,-1]))
WW <- as.data.frame(WW)
names(WW) <- c("threshold", "non shared", "shared")
#plot S2E
tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=6, height=6, res=300)
ggplot(WW, aes(x=factor(threshold), y=shared)) + geom_point() + ylab("fraction barcode shared between mice")+ xlab("PGEN threshold 10^-x") +theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()


#% bc deleted per mice
par(mfrow=c(2,2))
m1 <- cbind((S[,1]!=0),S[,5])
m1 <- m1[which(m1[,1]>0),]
W <- c(1, 0,0)
for (i in seq(1,8,0.5)) {
W <- rbind(W,c(1,i,1-dim(m1[which(m1[,2]<10^-i),])[1]/dim(m1)[1]))
}
m1 <- cbind((S[,2]!=0),S[,5])
m1 <- m1[which(m1[,1]>0),]
W <- rbind(W,c(2, 0,0))
for (i in seq(1,8,0.5)) {
W <- rbind(W,c(2,i,1-dim(m1[which(m1[,2]<10^-i),])[1]/dim(m1)[1]))
}
m1 <- cbind((S[,3]!=0),S[,5])
m1 <- m1[which(m1[,1]>0),]
W <- rbind(W,c(3, 0,0))
for (i in seq(1,8,0.5)) {
W <- rbind(W,c(3,i,1-dim(m1[which(m1[,2]<10^-i),])[1]/dim(m1)[1]))
}
m1 <- cbind((S[,4]!=0),S[,5])
m1 <- m1[which(m1[,1]>0),]
W <- rbind(W,c(4, 0,0))
for (i in seq(1,8,0.5)) {
W <- rbind(W,c(4,i,1-dim(m1[which(m1[,2]<10^-i),])[1]/dim(m1)[1]))
}
WW <- as.data.frame(W)
names(WW) <- c("mouse","threshold", "deleted")
#plot S2D
tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=6, height=6, res=300)
ggplot(WW, aes(x=factor(threshold), y=deleted, color=factor(mouse))) + geom_line(aes(group = mouse)) + geom_point()  +  labs(x="PGEN threshold 10^-x", y="fraction barcode deleted", col="mouse")+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))
dev.off()
```


## figure S2C

```{r, echo=FALSE}
#load data
d <- read.delim("/Users/jasoncosgrove/Dropbox (Team_Perie)/BCM paper/resubmission nature com/Urbanus et al, DRAG mouse (github v2)/code for figures/BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm repsum complexity probability yuval.txt",sep="\t")

#plot log frequency versus Pgen
x <- d[, -grep("X7_", colnames(d))] #remove control mice
x <- x[, -grep("X6_", colnames(x))] #remove control mice
xx <- cbind(rowSums(x[,-c(1,131)]*1000),x$Pgen)
xx <- as.data.frame(xx)
xx <- xx[which(xx[,1]>0),]
names(xx) <- c("freq","Pgen")
xx <- xx[which(xx$Pgen >0),]
xx <- xx[which(xx$Pgen >10^-14),]
xx$Pgen <- log10(xx$Pgen)
xx$cut <- cut(xx$Pgen, seq(-14,-1,1))
xx <- xx[which(xx$cut!=c("(-14,-13]")),]

tiff('/Users/jasoncosgrove/Desktop/test.tiff', units="in", width=9, height=6, res=300)
ggplot(xx[,], aes(x=factor(cut), y=freq)) + geom_boxplot() + scale_y_continuous(name="barcode clone size", trans='log10') + xlab("log10(barcode PGEN)")
dev.off()


```


## figure S6A 

```{r, echo=FALSE}
#load package
library("biomod2", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("ade4", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")

#sharing between time points
#load data
D <- read.delim("/Users/lperie/Documents/Leila/NL lab/projet NL/barcode mouse NL/analysis third and fourth sequencing rag+2/analyseleila/BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm repsum complexity probability yuval.txt",sep="\t")
d <- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb repsum.txt")
#subset data
dd <- d[,grep("_M", colnames(d))]
dd <- dd[,grep("X1_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),] # remove empty rows
dd <- dd[,c(3,9,4:7,1:2,8)] 
#binarize
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
#compute distance
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
#transform to value of sharing/jaccard
j1 <- as.matrix(1-j^2)
diag(j1) <- 1 # set diagonal to 1

#then same for  each mouse
dd <- d[,grep("_M", colnames(d))]
dd <- dd[,grep("X2_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]
dd <- dd[,c(8:9,3:6,1:2,7)]
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
j2 <- as.matrix(1-j^2)
diag(j2) <- 1

dd <- d[,grep("_M", colnames(d))]
dd <- dd[,grep("X3_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]
dd <- dd[,c(3:8,1:2,9)]
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
j3 <- as.matrix(1-j^2)
diag(j3) <- 1

dd <- d[,grep("_M", colnames(d))]
dd <- dd[,grep("X4_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]
dd <- dd[,c(3:8,1:2,9)]
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
j4 <- as.matrix(1-j^2)
diag(j4) <- 1

jt <- rbind(j1,j2,j3,j4)

#sharing between mice
#olad package
library("ecodist", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
#subset data: myeloid and up to 12 months
dd <- d[,grep("_M", colnames(d))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <- BinaryTransformation(dd, 0) #binarize
dd <- as.data.frame(dd)
dd <-dd[which(rowSums(dd)>0),] #remove empty rows
dd1 <- dd[,grep("X1_", colnames(dd))]#for mouse 1
dd2 <- dd[,grep("X2_", colnames(dd))]#for mouse 2
dd3 <- dd[,grep("X3_", colnames(dd))]#for mouse 3
dd4 <- dd[,grep("X4_", colnames(dd))]#for mouse 4

#compute jaccard index
m <- xdistance(t(dd1),t(dd2), method="jaccard")
m12 <- as.matrix(1-m)
m <- xdistance(t(dd1),t(dd3), method="jaccard")
m13 <- as.matrix(1-m)
m <- xdistance(t(dd1),t(dd4), method="jaccard")
m14 <- as.matrix(1-m)
m <- xdistance(t(dd2),t(dd3), method="jaccard")
m23 <- as.matrix(1-m)
m <- xdistance(t(dd2),t(dd4), method="jaccard")
m24 <- as.matrix(1-m)
m <- xdistance(t(dd3),t(dd4), method="jaccard")
m34 <- as.matrix(1-m)

m <- rbind(m12,m13,m14,m23,m24,m34) # merge all results


#sharing between replicates
#load data
D <- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb.txt")
n <- numeric(0)#empty vector
#subset data
dd <- D[,grep("_M", colnames(D))]
dd <- dd[,grep("X1_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]#remove empty rows
dd <- dd[,c(5:6,17:18,7:14,1:4,15:16)]
dd <- BinaryTransformation(dd, 0)#binarized
dd <- as.data.frame(dd)
#compute distance
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
#transform to jaccard index
j1 <- as.matrix(1-j^2)
diag(j1) <- 1#set diagonal to one

for (i in c(1:(dim(dd)[2]-1))) {
n <- rbind(n,cbind(sum(rowSums(dd[,c(i,i+1)]!=0)==2)/sum(rowSums(dd[,c(i,i+1)]!=0)!=0), sum(rowSums(dd[,c(i,i+1)]!=0)!=0)))
}     

dd <- D[,grep("_M", colnames(D))]
dd <- dd[,grep("X2_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]
dd <- dd[,c(15:18,5:12,1:4,13:14)]
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
j2 <- as.matrix(1-j^2)
diag(j2) <- 1

for (i in c(1:(dim(dd)[2]-1))) {
n <- rbind(n,cbind(sum(rowSums(dd[,c(i,i+1)]!=0)==2)/sum(rowSums(dd[,c(i,i+1)]!=0)!=0), sum(rowSums(dd[,c(i,i+1)]!=0)!=0)))
}  

dd <- D[,grep("_M", colnames(D))]
dd <- dd[,grep("X3_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]
dd <- dd[,c(5:16,1:4,17:18)]
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
j3 <- as.matrix(1-j^2)
diag(j3) <- 1

for (i in c(1:(dim(dd)[2]-1))) {
n <- rbind(n,cbind(sum(rowSums(dd[,c(i,i+1)]!=0)==2)/sum(rowSums(dd[,c(i,i+1)]!=0)!=0), sum(rowSums(dd[,c(i,i+1)]!=0)!=0)))
}  

dd <- D[,grep("_M", colnames(D))]
dd <- dd[,grep("X4_", colnames(dd))]
dd <- dd[,-grep("_13_", colnames(dd))]
dd <- dd[,-grep("_14_", colnames(dd))]
dd <- dd[,-grep("_15_", colnames(dd))]
dd <-dd[which(rowSums(dd)>0),]
dd <- dd[,c(5:16,1:4,17:18)]
dd <- BinaryTransformation(dd, 0)
dd <- as.data.frame(dd)
j <- dist.binary(t(dd), method = 1, diag = FALSE, upper = FALSE)
j4 <- as.matrix(1-j^2)
diag(j4) <- 1

for (i in c(1:(dim(dd)[2]-1))) {
n <- rbind(n,cbind(sum(rowSums(dd[,c(i,i+1)]!=0)==2)/sum(rowSums(dd[,c(i,i+1)]!=0)!=0), sum(rowSums(dd[,c(i,i+1)]!=0)!=0)))
}  

#plots S6A
par(mfrow=c(1,3))
hist(m, main="sharing between mice", freq=FALSE, xlim=c(0,0.5), breaks=seq(0,1,0.1),xlab="barcode shared (%)")
hist(n[,1], main="sharing between replicates", freq=FALSE,xlim=c(0,0.5), breaks=seq(0,1,0.1),xlab="barcode shared (%)")
hist(jt, main="sharing between timepoints", freq=FALSE, xlim=c(0,0.5), breaks=seq(0,1,0.1),xlab="barcode shared (%)")

```

## figure S6D

One reviewer is asking if D and J could recombined first and would then be followed by the V recombination later in the sibbling cells. IF this is happening and cells would divide before the V recombination, this would result in the barcoding of non unique cells. It could explain the increase of diversity over time. To test for this, we looked at how many identical DJ recombination had different V and how this proportion evolves over time within one mouse. We computed how many times DJ shared V between barcodes within single mouse over time in blood samples. We found no effect of this over time suggesting that this is not a confounding in our analysis. 

```{r, echo=FALSE}
#load data
D <- read.delim("~/Documents/Leila/NL lab/projet NL/barcode mouse NL/analysis third and fourth sequencing rag+2/analyseleila/BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm repsum complexity probability yuval.txt")
BL <- D[,-grep("_BM_",colnames(D))]
BL <- BL[,-grep("_L",colnames(BL))]
BL <- BL[,-grep("_SP",colnames(BL))]
#select non zero rows
BL<- BL[which(rowSums(BL[,-1])>0),]
#split per mouse
BL1<- cbind(BL[,1],BL[,grep("X1_",colnames(BL))])
names(BL1)[1]<- "tag"
BL1<- BL1[which(rowSums(BL1[,-1])>0),]
BL2<- cbind(BL[,1],BL[,grep("X2_",colnames(BL))])
names(BL2)[1]<- "tag"
BL2<- BL2[which(rowSums(BL2[,-1])>0),]
BL3<- cbind(BL[,1],BL[,grep("X3_",colnames(BL))])
names(BL3)[1]<- "tag"
BL3<- BL3[which(rowSums(BL3[,-1])>0),]
BL4<- cbind(BL[,1],BL[,grep("X4_",colnames(BL))])
names(BL4)[1]<- "tag"
BL4<- BL4[which(rowSums(BL4[,-1])>0),]

#load split of the barcodes into region
d <- read.delim("~/Documents/Leila/NL lab/projet NL/barcode mouse NL/analysis third and fourth sequencing rag+2/analyseleila/splitbc_run3and4_allsamples.txt")
#create sequence V+insVD and D+insDJ+J
d$Vall <- paste(d$V,d$insVD)
d$DJ <- paste(d$D,d$insDJ,d$J)

#merge with split of barcodes in part
C1 <- merge(BL1,d, by="tag")
C2 <- merge(BL2,d, by="tag")
C3 <- merge(BL3,d, by="tag")
C4 <- merge(BL4,d, by="tag")

#compute number of unique usage of each part per mouse
FF <- cbind(length(unique(C1$tag)),length(unique(C1$Vall)),length(unique(C1$DJ)),length(unique(C1$Vall))/length(unique(C1$tag))*100, length(unique(C1$DJ))/length(unique(C1$tag))*100)
FF <- as.data.frame(FF)
names(FF) <- c("unique barcodes", "unique V+insVD", "unique DJ","% unique V+insVD amoung total", "% unique DJ among total")
FF$mice <- "m1"
F<-FF

FF <- cbind(length(unique(C2$tag)),length(unique(C2$Vall)),length(unique(C2$DJ)),length(unique(C2$Vall))/length(unique(C2$tag))*100, length(unique(C2$DJ))/length(unique(C2$tag))*100)
FF <- as.data.frame(FF)
names(FF) <- c("unique barcodes", "unique V+insVD", "unique DJ","% unique V+insVD amoung total", "% unique DJ among total")
FF$mice <- "m2"
F <- rbind(F, FF)

FF <- cbind(length(unique(C3$tag)),length(unique(C3$Vall)),length(unique(C3$DJ)),length(unique(C3$Vall))/length(unique(C3$tag))*100, length(unique(C3$DJ))/length(unique(C3$tag))*100)
FF <- as.data.frame(FF)
names(FF) <- c("unique barcodes", "unique V+insVD", "unique DJ","% unique V+insVD amoung total", "% unique DJ among total")
FF$mice <- "m3"
F <- rbind(F, FF)

FF <- cbind(length(unique(C4$tag)),length(unique(C4$Vall)),length(unique(C4$DJ)),length(unique(C4$Vall))/length(unique(C4$tag))*100, length(unique(C4$DJ))/length(unique(C4$tag))*100)
FF <- as.data.frame(FF)
names(FF) <- c("unique barcodes", "unique V+insVD", "unique DJ","% unique V+insVD amoung total", "% unique DJ among total")
FF$mice <- "m4"
F <- rbind(F, FF)
#display result
print(F)

#reformat table
d1 <- melt(BL1, id.vars="tag")
d1 <- cbind(d1, ldply(strsplit(as.character(d1$variable), "_"), identity) ) # split the identifier column
names(d1) <- c("tag","id","var","mouse","month","organ","type") #give name to categories
d1<- d1[which(d1$var>0),]
d1 <- d1[,!colnames(d1)=="id"]#delete colonn id
x <- d1

d1 <- melt(BL2, id.vars="tag")
d1 <- cbind(d1, ldply(strsplit(as.character(d1$variable), "_"), identity) ) # split the identifier column
names(d1) <- c("tag","id","var","mouse","month","organ","type") #give name to categories
d1<- d1[which(d1$var>0),]
d1 <- d1[,!colnames(d1)=="id"]#delete colonn id
x <- rbind(x, d1)

d1 <- melt(BL3, id.vars="tag")
d1 <- cbind(d1, ldply(strsplit(as.character(d1$variable), "_"), identity) ) # split the identifier column
names(d1) <- c("tag","id","var","mouse","month","organ","type") #give name to categories
d1<- d1[which(d1$var>0),]
d1 <- d1[,!colnames(d1)=="id"]#delete colonn id
x <- rbind(x, d1)

d1 <- melt(BL4, id.vars="tag")
d1 <- cbind(d1, ldply(strsplit(as.character(d1$variable), "_"), identity) ) # split the identifier column
names(d1) <- c("tag","id","var","mouse","month","organ","type") #give name to categories
d1<- d1[which(d1$var>0),]
d1 <- d1[,!colnames(d1)=="id"]#delete colonn id
x <- rbind(x, d1)

#merge with split of barcodes in part
z <- d[,c(1,15,16)]
T <- merge(x,z, by="tag")

#compute number of V per DJ
temp<- ddply(T, c("mouse", "month", "DJ"),summarize,number_of_VinsVD=length(Vall))
temp$number_of_VinsVD <- as.factor(temp$number_of_VinsVD)
#ggplot(temp[which(temp$mouse=="X1"),], aes(x=month, fill=number_of_VinsVD)) + geom_bar() +ylab("count of #occurence")+xlab("")+ scale_x_continuous(breaks=seq(4,15,1))

Temp <- ddply(temp, c("mouse","month"), summarize, NV=table(number_of_VinsVD))
T <- ddply(Temp, c("mouse","month"), summarize, tot=sum(NV))
TempT <- merge(Temp,T, all=TRUE)
TempT$number_of_VinsVD <- rep(1:4,1)
TempT$freqV <- TempT$NV/TempT$tot
TempT$number_of_VinsVD <- as.factor(TempT$number_of_VinsVD)
TempT$month <- as.numeric(TempT$month)
#replace X by mouse
TempT <- 
#select 4 to 12 months
TempT <- TempT[which(TempT$month<13),]
#plot over time per mouse figS6D
ggplot(TempT, aes(fill=number_of_VinsVD, y=freqV, x=month)) + geom_bar(position="stack", stat="identity")+ylab("% of total barcodes")+xlab("Month post-induction")+ facet_wrap(~mouse) + scale_x_continuous(breaks=seq(4,15,1))+theme(axis.text=element_text(size=15,face="bold"),axis.title=element_text(size=16,face="bold"))+ labs(fill = "unique V per DJ recombination") 

```


## figure S2A

```{r, echo=FALSE}
#load splitting barcode data 
complex <- read.delim("splitbc_run3and4_complexity.txt", stringsAsFactors=FALSE)
#load barcoding data per sample
data <- read.delim("BCM run 3 and 4 freq10frac0_allsamples norm 1_0.003 renorm norm cell numb repsum.txt")
names(data)[1] <- "tag"
data <- data[,-1]
#select induced mice (mock mice are 5,6,7) 
datano5 <- data[,-grep("X5", colnames(data))]
datano5 <- datano5[,-grep("X6", colnames(datano5))]
datano5 <- datano5[,-grep("X7", colnames(datano5))]
datano5 <- datano5[,-grep("_L", colnames(datano5))] # no lymphoid samples
datano5 <- datano5[which(rowSums(datano5[,-1])>0),] 
#merge with barcoding data per sample
sumchangesno5 <- merge(complex,datano5,all=FALSE,by="tag")

#frequency of total insertions
par(mfrow=c(1,2))
a <- hist(sumchangesno5$numbinsDJ+sumchangesno5$numbinsVD, plot=FALSE, breaks=seq(0,max(sumchangesno5$numbinsDJ+sumchangesno5$numbinsVD),1), right=FALSE) #plot histogram
a$density <- a$counts/sum(a$counts)*100
plot(a,freq=FALSE, ylim=c(0,100), xlab="number of barcodes", main="% total insertion induced")

#frequency of total deletion
b <- hist(sumchangesno5$numbdelJ+sumchangesno5$numbdelDr+sumchangesno5$numbdelDl+sumchangesno5$numbdelV, plot=FALSE, right=FALSE)
b$density <- b$counts/sum(b$counts)*100
plot(b,freq=FALSE, ylim=c(0,30), xlab="number of barcodes", main="% total deletions induced")

#table of frequency of insertions and deletions
freqtotins <- cbind(a$counts/sum(a$counts)*100,a$breaks[-length(a$breaks)])
freqtotins
freqtotdel <- cbind(b$counts/sum(b$counts)*100,b$breaks[-length(b$breaks)])
freqtotdel

```



